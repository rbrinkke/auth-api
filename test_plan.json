{
  "test_suite_plan": {
    "overview": {
      "objective": "Implement comprehensive test suite achieving >90% code coverage",
      "test_types": ["Unit", "Integration", "End-to-End"],
      "target_coverage": "90-95%",
      "testing_framework": "pytest with pytest-asyncio",
      "quality_standard": "Enterprise-grade, production-ready tests"
    },
    "infrastructure": {
      "dependencies": {
        "pytest": "^7.4.0",
        "pytest-asyncio": "^0.21.0",
        "pytest-mock": "^3.12.0",
        "pytest-cov": "^4.1.0",
        "httpx": "^0.27.0"
      },
      "test_database": {
        "setup": "Separate test database created via pytest fixture",
        "connection_pool": "Test-specific pool with rollback support",
        "isolation": "Each test gets clean state"
      },
      "test_redis": {
        "setup": "Separate Redis instance for testing",
        "cleanup": "Flush after each test"
      },
      "docker_compose_test": {
        "description": "docker-compose.test.yml for isolated test environment",
        "services": ["test-postgres", "test-redis", "auth-api"],
        "lifecycle": "Started before tests, stopped after"
      }
    },
    "test_structure": {
      "directory": "tests/",
      "organization": {
        "unit": {
          "path": "tests/unit/",
          "description": "Fast unit tests with mocked dependencies",
          "files": {
            "test_registration_service.py": "RegistrationService with mocked DB/Redis/Email",
            "test_password_validation_service.py": "PasswordValidation with mocked zxcvbn/HIBP",
            "test_password_reset_service.py": "PasswordResetService with mocked dependencies",
            "test_email_service.py": "EmailService with mocked HTTP client",
            "test_token_handler.py": "Token generation and validation",
            "test_security.py": "Password hashing, JWT operations"
          }
        },
        "integration": {
          "path": "tests/integration/",
          "description": "Tests with real database and Redis",
          "files": {
            "test_registration_flow.py": "Full registration with DB operations",
            "test_password_reset_flow.py": "End-to-end password reset",
            "test_token_blacklist.py": "Redis-backed token blacklist",
            "test_user_verification.py": "Email verification flow",
            "test_concurrent_operations.py": "Race conditions and concurrency"
          }
        },
        "e2e": {
          "path": "tests/e2e/",
          "description": "Full API testing via HTTP",
          "files": {
            "test_register_endpoint.py": "Registration via HTTP",
            "test_login_endpoint.py": "Login and JWT flow",
            "test_rate_limiting.py": "Rate limiting enforcement",
            "test_security_headers.py": "Security headers validation",
            "test_health_check.py": "Health monitoring"
          }
        }
      }
    },
    "unit_tests": {
      "registration_service": {
        "test_password_validation": [
          "Strong password passes",
          "Weak password raises PasswordValidationError",
          "Breached password raises error",
          "HIBP service unavailable (graceful degradation)"
        ],
        "test_user_creation": [
          "Valid user creation",
          "Duplicate email raises UserAlreadyExistsError",
          "Database connection failure handling"
        ],
        "test_token_generation": [
          "Verification token created",
          "Token stored in Redis with TTL",
          "Token retrieval works"
        ],
        "test_concurrent_registration": [
          "Simultaneous registrations handled correctly",
          "No race conditions"
        ]
      },
      "password_validation_service": {
        "test_strength_validation": [
          "Score 0-2 rejected",
          "Score 3-4 accepted",
          "zxcvbn not available (fallback)",
          "Custom error messages"
        ],
        "test_breach_check": [
          "Password not in breaches",
          "Password found in breaches",
          "HIBP API failure handling",
          "Non-blocking I/O (asyncio.to_thread)"
        ]
      },
      "password_reset_service": {
        "test_request_reset": [
          "Valid user gets token",
          "Non-existent user gets generic response",
          "Token stored with TTL"
        ],
        "test_reset_password": [
          "Valid token updates password",
          "Invalid token rejected",
          "Expired token rejected",
          "Single-use enforcement"
        ]
      },
      "email_service": {
        "test_send_email": [
          "HTTP 200 success",
          "HTTP error handling",
          "Timeout handling",
          "Template rendering"
        ],
        "test_verification_email": [
          "Correct template used",
          "Verification link included",
          "Email validation"
        ]
      },
      "security": {
        "test_password_hashing": [
          "Argon2id implementation",
          "Salt uniqueness",
          "Verification works",
          "Slow hash (brute force resistance)"
        ],
        "test_jwt_tokens": [
          "Access token generation",
          "Refresh token generation",
          "Token validation",
          "Expiration handling"
        ]
      }
    },
    "integration_tests": {
      "database_operations": {
        "test_stored_procedures": [
          "sp_create_user creates user correctly",
          "sp_get_user_by_email retrieves user",
          "sp_update_password changes password",
          "Transaction rollback on error"
        ],
        "test_connection_pool": [
          "Pool size respected",
          "Connection reuse",
          "Graceful cleanup"
        ]
      },
      "redis_operations": {
        "test_token_storage": [
          "Verification tokens with TTL",
          "Reset tokens with TTL",
          "Token retrieval",
          "Token deletion"
        ],
        "test_blacklist": [
          "Token added to blacklist",
          "Blacklisted tokens rejected",
          "TTL enforcement"
        ]
      },
      "email_integration": {
        "test_real_email_sending": [
          "Dummy email service integration",
          "MailHog receives email",
          "Email content verified"
        ]
      }
    },
    "e2e_tests": {
      "registration_flow": {
        "test_valid_registration": [
          "Complete registration with strong password",
          "Email sent in background",
          "Verification email received",
          "User can verify email",
          "User can login after verification"
        ],
        "test_invalid_registration": [
          "Weak password rejected",
          "Breached password rejected",
          "Duplicate email rejected",
          "Invalid email format rejected"
        ]
      },
      "authentication_flow": {
        "test_login": [
          "Valid credentials work",
          "Unverified user cannot login",
          "Invalid credentials rejected",
          "Rate limiting enforced"
        ],
        "test_jwt_refresh": [
          "Access token expires correctly",
          "Refresh token rotates",
          "Old refresh tokens rejected",
          "Blacklist works on logout"
        ]
      },
      "security_validations": {
        "test_security_headers": [
          "X-Content-Type-Options present",
          "X-XSS-Protection present",
          "X-Frame-Options set to DENY",
          "Server header hidden"
        ],
        "test_exception_handling": [
          "No stack traces in production",
          "Generic error messages",
          "Internal errors logged",
          "Status codes correct"
        ]
      }
    },
    "coverage_targets": {
      "overall": "90-95%",
      "services": "95%+",
      "routes": "90%+",
      "core": "95%+",
      "excluded": ["migrations", "config.py", "main.py (bootstrapping)"]
    },
    "ci_cd_integration": {
      "pre_commit_hooks": {
        "pytest": "Run unit tests before commit",
        "coverage": "Fail if coverage < 90%",
        "mypy": "Type checking",
        "black": "Code formatting",
        "isort": "Import sorting"
      },
      "github_actions": {
        "test_job": {
          "runs_on": "ubuntu-latest",
          "steps": [
            "Checkout code",
            "Set up Python 3.12",
            "Install dependencies",
            "Start test database/Redis",
            "Run pytest with coverage",
            "Upload coverage to Codecov"
          ]
        }
      }
    },
    "execution_order": [
      "1. Set up test dependencies",
      "2. Create test infrastructure (docker-compose.test.yml)",
      "3. Create pytest configuration",
      "4. Implement unit tests",
      "5. Implement integration tests",
      "6. Implement E2E tests",
      "7. Configure coverage reporting",
      "8. Add pre-commit hooks",
      "9. Run full test suite",
      "10. Achieve >90% coverage",
      "11. Document test usage"
    ],
    "success_criteria": {
      "all_tests_pass": true,
      "coverage_achieved": ">= 90%",
      "no_flaky_tests": true,
      "fast_execution": "Unit tests < 30s, Integration < 60s",
      "parallel_execution": "Tests can run in parallel",
      "documentation_complete": "Test docs written"
    }
  }
}
